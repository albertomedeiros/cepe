tinymce.PluginManager.add("footnotes",function(t){function n(t,n){var e=t;for(var o in n)e=e.replace("{"+o+"}",n[o]);return e}function e(){var e=t.selection.getNode(),o="",a="SPAN"==e.tagName&&-1!==t.dom.getAttrib(e,"class").indexOf("fnoteWrap"),i=function(){if(-1!==e.className.indexOf("fnoteWrap")){var n=e.childNodes[0].firstChild.nodeValue.replace(/[^0-9]/g,"");return t.selection.select(e),n}return e.childNodes[0]}();a&&(o=e.name||decodeURIComponent(e.getAttribute("data-nota"))||""),t.windowManager.open({title:"Insert a contents",id:"footnote-dialog",body:{type:"textbox",name:"name",multiline:!0,minWidth:520,minHeight:100,value:o},onSubmit:function(e){var o,a=e.data.name,r=(encodeURIComponent(a),'<span class="fnoteWrap nota" data-nota="'+a+'" id="#wk_ft{FOOTNOTE_INDEX}" contenteditable="false"><button class="fnoteBtn">'+t.selection.getContent({format:"text"})+"</button></span>"),l=t.getDoc().querySelectorAll(".fnoteBtn"),f=l.length,c=function(t){function n(t){return t.nextAll().find(".fnoteBtn").length>0?t.next().hasClass("fnoteBtn")?t.next().children().children():t.nextAll().find(".fnoteBtn"):"BODY"==t.prop("nodeName")?[]:n(t.parent())}function e(t,n){if(!n)return!1;if(n)return n;var o=null;return n.children().each(function(){n&&(o=e(t,$(this)))}),o}return function(t,o){for(var a=n(o);0!==a.length;){var i=e(t,a);if(null!==i)return i;a=n(a)}return a}(".fnoteBtn",t)}($(t.selection.getRng().endContainer));if(c.length){c=c[0];var d;for(d=0;d<f&&c!=l[d];d++);o=i<f?n(r,{FOOTNOTE_INDEX:$(l[i-1]).html()}):n(r,{FOOTNOTE_INDEX:$(l[d]).html()})}else o=n(r,{FOOTNOTE_INDEX:f+1});t.execCommand("mceInsertContent",!1,o),$(t.getDoc()).find(".fnoteBtn").each(function(t){$(this).parent().attr("id","#wk_ft"+(t+1))})}})}t.addCommand("mceFootnotes",e),t.addButton("footnotes",{title:"Nota de rodapÃ©",image:tinyMCE.baseURL+"/plugins/footnotes/img/footnotes.png",onclick:e,stateSelector:"span.fnoteWrap"})});